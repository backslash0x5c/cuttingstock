# 鉄筋切断最適化アプリ

鉄筋の切断パターンを最適化し、廃材を最小化するStreamlitベースのWebアプリケーションです。深さ優先探索アルゴリズムと整数線形計画法を使用して、最適な切断計画を生成します。

## 主な機能

### 🎯 最適化機能
- **複数径同時最適化**: 全ての鉄筋径（D10、D13、D16、D19、D22）を同時に最適化
- **複数材料最適化**: 各径ごとにすべての利用可能な棒の長さを使用した最適化
- **柔軟な材料選択**: チェックボックスで各径ごとに使用する材料長を選択可能
- **再利用端材の活用**: 既存の端材を優先的に使用して新材料の使用量を削減
- **シート単位の割り当て**: 切断パターンを施工シート単位で適切な実行順序で割り当て

### 📊 入力方法
1. **XLSXファイルアップロード**: 切断集計表のExcelファイルから全径のデータを自動読み込み
2. **再利用端材CSV入力**: 径情報を含む既存の端材データをCSVファイルで入力（オプション）

### 📈 結果表示
- **シート別統合ビュー**: 全径の切断順序を施工シート単位で表示
- **在庫操作の追跡**: 各シートの材料取り出しと保管操作を記録
- **色分け表示**: シートごとに異なる背景色で識別しやすく表示
- 各径ごとの歩留り率の計算（再利用なし/再利用あり）
- 各径ごとの切断パターンの詳細表示
- 全径統合の再利用可能な端材リスト（閾値以上）
- 各径ごとの処理時間と組み合わせ数の統計

### 💾 ダウンロード機能
- **シート別切断順序Excel**: 施工シート単位で整理された完全な切断順序
- **全径統合再利用端材リストCSV**: 全径の端材と使用されなかった再利用端材を統合
- **各径別最適化結果Excel**: 各径ごとの切断パターン、集計表、サマリーシートを含む

## 使用方法

### アプリケーションの起動

```bash
streamlit run cutting_optimizer_streamlit_v4.py
```

### 基本的な使い方

1. **材料長の選択**: チェックボックスで各径（D10-D22）ごとに使用可能な材料長を選択
2. **時間制限の設定**: 最適化計算の制限時間を設定（10-3600秒、デフォルト: 120秒）
3. **XLSXファイルのアップロード**: 全径のデータを含む切断集計表をアップロード
4. **再利用端材の入力（オプション）**: 3列（径、長さ、本数）形式のCSVファイルをアップロード
   ```csv
   鉄筋径,端材の長さ (mm),本数
   D13,405,3
   D13,1000,1
   D16,1915,2
   ```
5. **端材閾値の設定**: 再利用可能な端材の最小長さを設定（デフォルト: 400mm）
6. **最適化の実行**: ボタンをクリックして複数径の最適化を開始
7. **シート別結果の確認**: 施工シート別の統合切断順序を確認
8. **径別詳細の確認**: タブで各径の詳細結果を確認
9. **結果のダウンロード**: シート別切断順序と統合端材リストをダウンロード

## 依存パッケージ

```bash
pip install streamlit pandas pulp openpyxl
```

- `streamlit`: Webインターフェース
- `pandas`: データ処理とCSV/Excel操作
- `pulp`: 整数線形計画法ソルバー
- `openpyxl`: Excelファイルの読み書き

## 対応鉄筋径と利用可能な棒の長さ

```python
BASE_PATTERNS = {
    'D10': [4000, 4500, 5500, 6000],
    'D13': [3000, 4000, 4500, 5500, 6000, 7500],
    'D16': [4000, 4500, 5500, 6000, 7000],
    'D19': [3500, 4000, 4500, 5500, 6000],
    'D22': [4000, 4500, 5500, 6000]
}
```

## アルゴリズム

### 1. 深さ優先探索 (DFS)
- 利用可能な材料長さ内で切り出し可能な全ての組み合わせを生成
- 枝刈りにより無効な組み合わせを除外（current_sum > max_sum）
- 計算済みの組み合わせを再利用して効率化

### 2. 整数線形計画法 (ILP)
- PuLPライブラリを使用して最適化問題を解決
- 目的関数: 総ロス（端材）の最小化
- 制約条件:
  - 需要制約: 各切り出し長さの必要本数を満たす
  - 再利用端材制約: 各再利用材料の利用可能本数を超えない

### 3. 再利用端材の処理
- 各径ごとに入力された再利用端材から切断パターンを生成
- 最適化時に優先的に使用（本数制約付き）
- 使用されなかった端材を新しい端材と統合してダウンロード

### 4. シート単位のパターン割り当て
- 切断パターンを施工シート単位で実行順序に従って割り当て
- シート間の在庫操作（取り出し/保管）を追跡
- パターンとシート需要をマッチングして中間在庫を最小化
- XLSXファイルの元のシート順序を維持

## データフロー

```
[入力]
  ├─ 切断指示 (XLSX - 全径対応)
  ├─ 再利用端材 (CSV - 径列付き)
  └─ 材料選択 (径ごとのチェックボックス)
      ↓
[処理 - 径ごと]
  ├─ 組み合わせ生成 (DFS)
  ├─ 最適化計算 (ILP)
  └─ パターンのシート割り当て
      ↓
[統合]
  ├─ 径間での結果マージ
  ├─ シート順序と径でソート
  └─ 在庫操作の追跡
      ↓
[出力]
  ├─ シート別切断順序 (Excel)
  ├─ 径別詳細結果 (タブ表示)
  ├─ 歩留り率計算 (径ごと)
  ├─ 全径統合再利用端材リスト (CSV)
  └─ 径別最適化結果 (Excel)
```

## 複数径対応の再利用端材循環利用

### 入力例（径列付きCSV）
```csv
鉄筋径,端材の長さ (mm),本数
D13,405,3
D13,1000,1
D16,1915,2
```

### 最適化結果（径ごと）
- **D13**: 405mm×1本使用、1000mm×1本未使用
- **D16**: 1915mm×2本使用
- **新しい端材**: D13: 610mm×5本、D16: 1020mm×2本、830mm×3本

### ダウンロードCSV（全径統合後）
```csv
鉄筋径,端材の長さ (mm),本数
D16,1020,2
D13,1000,1
D16,830,3
D13,610,5
D13,405,2
```

## パフォーマンス設定

- **最適化制限時間**: 10～3600秒（デフォルト: 120秒）
- **組み合わせ生成**: 大規模問題では計算に時間がかかる場合があります
- **結果保存**: セッション状態に保存され、閾値変更時も再計算なしで表示更新

## ファイル構造

```
cuttingstock/
├── cutting_optimizer_streamlit_v4.py  # メインアプリケーション（複数径対応）
├── cutting_optimizer_streamlit_v2.py  # 旧バージョン（単一径）
├── README.md                          # 英語版README
├── README_ja.md                       # このファイル
└── test_scrap.csv                     # テスト用端材データ
```

## 出力結果の詳細

### シート別切断順序表（全径統合）
- 切断順序番号、シート名、径、操作種別
- 本数、ベース材料長、切断パターン、ロス
- シートごとに色分けして識別しやすく表示
- 在庫取り出しと保管操作も含む

### 径別切断パターン表
- ID、切断順序、シート名、操作種別
- ベース材料長、切断パターン、ロス
- シートごとに色分け、再利用材料は別色でハイライト

### 出力結果集計表（径ごと）
- 各切り出し長さの合計本数
- 合計行に数式設定

### 切断指示集計表（XLSXアップロード時、径ごと）
- シートごとの切断指示データ
- 合計行と差分計算

### サマリーシート（径ごと）
- 径、歩留り率（再利用なし/あり）、総材料長
- 処理時間、端材閾値
- 出力結果と切断指示の差分表示

## 注意事項

- **再利用端材CSVファイル**は「鉄筋径,端材の長さ (mm),本数」の3列形式で作成してください
- **材料選択**は最適化したい各径ごとに必要です
- **シート順序**は統合ビューで元のXLSXファイルの順序に従います
- 同じ径と長さの端材は自動的に集約されます
- 再利用端材の使用は任意で、アップロードしない場合は通常の最適化が実行されます
- 大規模な問題（複数径、多くの切断種類）では制限時間を長めに設定することを推奨します
- アプリは選択された材料長が切断要件を満たせるか自動的に検証します

## ライセンス

このプロジェクトは鉄筋切断の最適化を目的としたツールです。
